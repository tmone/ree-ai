name: REE AI CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================================
  # UNIT TESTS (Fast, no external dependencies)
  # ============================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install -r tests/requirements.txt
        pip install -r requirements.txt

    - name: Run unit tests
      run: |
        pytest tests/ -m unit -v --tb=short --junit-xml=test-results/unit-tests.xml
      env:
        PYTHONPATH: .

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: unit-test-results
        path: test-results/unit-tests.xml

  # ============================================================
  # INTEGRATION TESTS (Requires Docker services)
  # ============================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Start infrastructure services
      run: |
        docker-compose -f docker-compose.test.yml up -d postgres redis opensearch ollama
        sleep 15

    - name: Start Service Registry
      run: |
        docker-compose -f docker-compose.test.yml up -d service-registry
        sleep 10

    - name: Wait for Service Registry
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'

    - name: Start Core Services
      run: |
        docker-compose -f docker-compose.test.yml up -d core-gateway db-gateway
        sleep 10

    - name: Start AI Services
      run: |
        docker-compose -f docker-compose.test.yml up -d semantic-chunking classification
        sleep 10

    - name: Start Orchestrator
      run: |
        docker-compose -f docker-compose.test.yml up -d orchestrator
        sleep 10

    - name: Wait for services to register
      run: sleep 10

    - name: Run integration tests
      run: |
        docker-compose -f docker-compose.test.yml run --rm test-runner \
          pytest /app/tests -m integration -v --tb=short --junit-xml=/app/test-results/integration-tests.xml

    - name: Copy test results
      if: always()
      run: |
        docker cp $(docker-compose -f docker-compose.test.yml ps -q test-runner):/app/test-results ./test-results || true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: test-results/

    - name: Show service logs on failure
      if: failure()
      run: |
        echo "=== Service Registry Logs ==="
        docker-compose -f docker-compose.test.yml logs service-registry
        echo "=== Orchestrator Logs ==="
        docker-compose -f docker-compose.test.yml logs orchestrator

    - name: Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # ============================================================
  # END-TO-END TESTS (Full workflow)
  # ============================================================
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Run E2E tests
      run: |
        chmod +x scripts/run-tests.sh
        ./scripts/run-tests.sh --e2e

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: e2e-test-results
        path: test-results/

    - name: Cleanup
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  # ============================================================
  # BUILD CHECK (Ensure all services build)
  # ============================================================
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build all services
      run: |
        docker-compose -f docker-compose.yml build \
          service-registry \
          core-gateway \
          db-gateway \
          semantic-chunking \
          classification \
          orchestrator \
          rag-service \
          api-gateway \
          auth-service

    - name: Show build summary
      run: |
        docker images | grep ree-ai
