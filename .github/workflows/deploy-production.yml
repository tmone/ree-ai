name: Deploy to Production

on:
  push:
    branches: [ release ]  # Auto-deploy from release branch
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm'
        required: true
        default: 'CANCEL'

jobs:
  # ============================================================
  # PRE-DEPLOYMENT VALIDATION
  # ============================================================
  pre-deploy-checks:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      deploy_approved: ${{ steps.validation.outputs.approved }}
      deployment_env: ${{ steps.validation.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate deployment request
      id: validation
      run: |
        echo "üîç Validating deployment request..."
        
        # Determine deployment environment
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          DEPLOY_ENV="${{ github.event.inputs.environment }}"
          CONFIRMATION="${{ github.event.inputs.confirm_deployment }}"
          
          if [ "$CONFIRMATION" != "DEPLOY" ]; then
            echo "‚ùå Deployment requires confirmation!"
            echo "Please type 'DEPLOY' in the confirmation field"
            exit 1
          fi
          
          echo "‚úÖ Manual deployment confirmed for: $DEPLOY_ENV"
        else
          # Auto-deployment from push
          DEPLOY_ENV="production"
          echo "‚úÖ Auto-deployment triggered from release branch"
        fi
        
        # Validate branch
        if [ "${{ github.ref_name }}" != "release" ]; then
          echo "‚ùå Production deployment only allowed from release branch"
          echo "Current branch: ${{ github.ref_name }}"
          exit 1
        fi
        
        # Validate required files
        if [ ! -f "docker-compose.yml" ]; then
          echo "‚ùå docker-compose.yml not found"
          exit 1
        fi
        
        if [ ! -f "scripts/deploy-production.sh" ]; then
          echo "‚ùå Deployment script not found"
          exit 1
        fi
        
        echo "‚úÖ Pre-deployment validation passed"
        echo "approved=true" >> $GITHUB_OUTPUT
        echo "environment=$DEPLOY_ENV" >> $GITHUB_OUTPUT

  # ============================================================
  # DEPLOYMENT
  # ============================================================
  deploy:
    name: Deploy to ${{ needs.pre-deploy-checks.outputs.deployment_env }}
    runs-on: [self-hosted, linux, x64, production]
    timeout-minutes: 30
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.deploy_approved == 'true'
    
    environment: 
      name: ${{ needs.pre-deploy-checks.outputs.deployment_env }}
      url: http://${{ vars.SERVER_HOST || 'localhost' }}:3000

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup deployment environment
      run: |
        echo "ÔøΩ Setting up deployment environment..."
        
        # Make deployment script executable
        chmod +x scripts/deploy-production.sh
        
        # Validate environment variables
        if [ "${{ needs.pre-deploy-checks.outputs.deployment_env }}" = "production" ]; then
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "‚ùå OPENAI_API_KEY secret not configured"
            exit 1
          fi
          
          if [ -z "${{ secrets.JWT_SECRET_KEY }}" ]; then
            echo "‚ùå JWT_SECRET_KEY secret not configured"
            exit 1
          fi
          
          if [ -z "${{ secrets.WEBUI_SECRET_KEY }}" ]; then
            echo "‚ùå WEBUI_SECRET_KEY secret not configured"
            exit 1
          fi
        fi
        
        echo "‚úÖ Environment setup completed"

    - name: Run deployment
      env:
        DEPLOYMENT_ENV: ${{ needs.pre-deploy-checks.outputs.deployment_env }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        WEBUI_SECRET_KEY: ${{ secrets.WEBUI_SECRET_KEY }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'ree_ai_pass_2025' }}
        OPENSEARCH_PASSWORD: ${{ secrets.OPENSEARCH_PASSWORD || 'Admin123!@#' }}
        PROJECT_NAME: ree-ai
        LOG_LEVEL: INFO
      run: |
        echo "ÔøΩ Starting deployment..."
        ./scripts/deploy-production.sh \
          --env "$DEPLOYMENT_ENV" \
          --project-dir "$(pwd)" \
          --log-level "$LOG_LEVEL"

    - name: Post-deployment verification
      run: |
        echo "üß™ Running post-deployment verification..."
        
        # Wait for services to stabilize
        sleep 30
        
        # Advanced health checks
        services=(
          "localhost:8000/health|Service Registry"
          "localhost:8080/health|Core Gateway"
          "localhost:8081/health|DB Gateway"
          "localhost:8090/health|Orchestrator"
          "localhost:8091/health|RAG Service"
          "localhost:3000|Open WebUI"
        )
        
        failed_services=()
        
        for service_info in "${services[@]}"; do
          IFS='|' read -r endpoint name <<< "$service_info"
          
          echo "Testing $name..."
          if timeout 10 curl -f "http://$endpoint" >/dev/null 2>&1; then
            echo "‚úÖ $name: OK"
          else
            echo "‚ùå $name: FAILED"
            failed_services+=("$name")
          fi
        done
        
        if [ ${#failed_services[@]} -eq 0 ]; then
          echo "‚úÖ All services are healthy"
        else
          echo "‚ö†Ô∏è Failed services: ${failed_services[*]}"
          echo "üìã Service status:"
          docker-compose ps
          
          # Don't fail deployment for non-critical services
          echo "üîç Checking critical services only..."
          critical_services=("Service Registry" "Core Gateway" "Open WebUI")
          critical_failed=()
          
          for service in "${critical_services[@]}"; do
            if [[ " ${failed_services[*]} " =~ " ${service} " ]]; then
              critical_failed+=("$service")
            fi
          done
          
          if [ ${#critical_failed[@]} -gt 0 ]; then
            echo "‚ùå Critical services failed: ${critical_failed[*]}"
            exit 1
          else
            echo "‚úÖ Critical services are healthy"
          fi
        fi

    - name: Deployment summary
      if: always()
      run: |
        # Get server information
        SERVER_IP=$(hostname -I | awk '{print $1}' || echo "localhost")
        DEPLOYMENT_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        cat << EOF
        
        ==========================================
        üöÄ REE AI Deployment Summary
        ==========================================
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Environment: ${{ needs.pre-deploy-checks.outputs.deployment_env }}
        Deployed by: ${{ github.actor }}
        Timestamp: $DEPLOYMENT_TIME
        Server: $SERVER_IP
        
        üåê Access URLs:
          - Open WebUI: http://$SERVER_IP:3000
          - Core Gateway: http://$SERVER_IP:8080
          - Service Registry: http://$SERVER_IP:8000
          - Orchestrator: http://$SERVER_IP:8090
          - RAG Service: http://$SERVER_IP:8091
        
        üìä Infrastructure:
          - PostgreSQL: port 5432
          - Redis: port 6379  
          - OpenSearch: port 9200
        
        üìã Management:
          - View logs: docker-compose logs [service]
          - Stop services: docker-compose down
          - Service status: docker-compose ps
        
        Status: ${{ job.status == 'success' && '‚úÖ SUCCESS' || '‚ùå FAILED' }}
        ==========================================
        
        EOF