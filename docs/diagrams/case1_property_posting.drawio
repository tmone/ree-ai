<mxfile host="app.diagrams.net">
  <diagram name="Case 1: Property Posting" id="case1">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="900">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="Case 1: Property Posting (POST_SALE / POST_RENT)" style="text;fontSize=18;fontStyle=1;align=center;" vertex="1" parent="1">
          <mxGeometry x="400" y="40" width="600" height="30" as="geometry" />
        </mxCell>

        <!-- Entry -->
        <mxCell id="user" value="USER" style="shape=actor;fillColor=#90EE90;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="80" y="140" width="40" height="60" as="geometry" />
        </mxCell>

        <mxCell id="webui" value="Open WebUI" style="rounded=1;fillColor=#90EE90;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="180" y="150" width="120" height="40" as="geometry" />
        </mxCell>

        <!-- Orchestrator -->
        <mxCell id="orch" value="Orchestrator" style="rounded=1;fillColor=#FFD700;strokeColor=#333333;strokeWidth=3;fontStyle=1;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="380" y="140" width="140" height="60" as="geometry" />
        </mxCell>

        <!-- Services -->
        <mxCell id="service_label" value="Layer 3 Services" style="text;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="750" y="100" width="150" height="30" as="geometry" />
        </mxCell>

        <mxCell id="classification" value="Classification Service&#xa;:8083" style="rounded=1;fillColor=#FFEB99;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="750" y="140" width="180" height="50" as="geometry" />
        </mxCell>

        <mxCell id="extraction" value="Extraction Service&#xa;:8084" style="rounded=1;fillColor=#FFEB99;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="750" y="320" width="180" height="50" as="geometry" />
        </mxCell>

        <mxCell id="completeness" value="Completeness Service&#xa;:8086" style="rounded=1;fillColor=#FFEB99;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="750" y="440" width="180" height="50" as="geometry" />
        </mxCell>

        <!-- Internal Loop Box -->
        <mxCell id="loop_box" value="" style="rounded=1;fillColor=none;strokeColor=#E74C3C;strokeWidth=3;dashed=1;dashPattern=5 5;" vertex="1" parent="1">
          <mxGeometry x="340" y="260" width="220" height="300" as="geometry" />
        </mxCell>

        <mxCell id="loop_label" value="INTERNAL REASONING LOOP&#xa;(within single request)" style="text;fontSize=12;fontStyle=1;fontColor=#E74C3C;" vertex="1" parent="1">
          <mxGeometry x="345" y="270" width="210" height="35" as="geometry" />
        </mxCell>

        <!-- Loop Steps -->
        <mxCell id="step1" value="Step 1:&#xa;Extract Attributes" style="rounded=1;fillColor=#E8F4F8;strokeColor=#4A90E2;strokeWidth=2;dashed=1;dashPattern=3 3;" vertex="1" parent="1">
          <mxGeometry x="370" y="320" width="160" height="50" as="geometry" />
        </mxCell>

        <mxCell id="step2" value="Step 2:&#xa;Assess Completeness" style="rounded=1;fillColor=#E8F4F8;strokeColor=#4A90E2;strokeWidth=2;dashed=1;dashPattern=3 3;" vertex="1" parent="1">
          <mxGeometry x="370" y="400" width="160" height="50" as="geometry" />
        </mxCell>

        <mxCell id="decision" value="Satisfied?&#xa;Score &gt;= 80&#xa;OR max iter" style="rhombus;fillColor=#FFE6CC;strokeColor=#D79B00;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="390" y="480" width="120" height="80" as="geometry" />
        </mxCell>

        <!-- Exit loop -->
        <mxCell id="step3" value="Step 3:&#xa;Generate Response" style="rounded=1;fillColor=#E8F4F8;strokeColor=#4A90E2;strokeWidth=2;dashed=1;dashPattern=3 3;" vertex="1" parent="1">
          <mxGeometry x="370" y="600" width="160" height="50" as="geometry" />
        </mxCell>

        <mxCell id="response" value="Response:&#xa;Completeness feedback" style="rounded=1;fillColor=#90EE90;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="370" y="690" width="160" height="50" as="geometry" />
        </mxCell>

        <!-- Storage -->
        <mxCell id="postgres" value="PostgreSQL&#xa;Save History" style="shape=cylinder;fillColor=#B0E0B0;strokeColor=#333333;strokeWidth=2;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="690" width="120" height="60" as="geometry" />
        </mxCell>

        <!-- Connections -->
        <mxCell id="e1" value="" edge="1" parent="1" source="user" target="webui">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e2" value="" edge="1" parent="1" source="webui" target="orch">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e3" value="1. Detect Intent" edge="1" parent="1" source="orch" target="classification" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e4" value="2. Extract&#xa;(loop N times)" edge="1" parent="1" source="step1" target="extraction" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e5" value="3. Assess&#xa;(loop N times)" edge="1" parent="1" source="step2" target="completeness" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e6" value="Start loop" edge="1" parent="1" source="orch" target="step1" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e7" value="entities" edge="1" parent="1" source="step1" target="step2" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e8" value="score" edge="1" parent="1" source="step2" target="decision" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e9" value="NO: Continue" edge="1" parent="1" source="decision" target="step1" style="dashed=1;dashPattern=5 5;strokeWidth=3;strokeColor=#E74C3C;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="290" y="520" />
              <mxPoint x="290" y="345" />
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="e10" value="YES: Exit loop" edge="1" parent="1" source="decision" target="step3" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e11" value="" edge="1" parent="1" source="step3" target="response" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e12" value="4. Save" edge="1" parent="1" source="response" target="postgres" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e13" value="" edge="1" parent="1" source="response" target="webui" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="250" y="715" />
              <mxPoint x="250" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Notes -->
        <mxCell id="note1" value="Loop: 1-5 iterations&#xa;Within single request&#xa;Reasoning + Re-extraction" style="rounded=0;fillColor=#FFF9C4;strokeColor=#F57C00;strokeWidth=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="60" y="320" width="190" height="70" as="geometry" />
        </mxCell>

        <mxCell id="note2" value="Exit Conditions:&#xa;1. Score &gt;= 80 (satisfied)&#xa;2. Max iterations (5)&#xa;3. No improvement" style="rounded=0;fillColor=#FFF9C4;strokeColor=#F57C00;strokeWidth=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="60" y="420" width="190" height="90" as="geometry" />
        </mxCell>

        <!-- Example -->
        <mxCell id="example" value="Example Single Request:&#xa;User: Can ban nha Q7 2PN 5ty&#xa;&#xa;Loop 1: Extract - Score 50&#xa;Loop 2: Re-extract context - Score 60&#xa;Loop 3: Final - Score 65&#xa;&#xa;Response: Da hieu 2PN Q7 5ty&#xa;Can bo sung: dien tich, dia chi" style="rounded=0;fillColor=#E1F5E1;strokeColor=#4CAF50;strokeWidth=2;align=left;" vertex="1" parent="1">
          <mxGeometry x="60" y="550" width="250" height="180" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend" value="Legend:&#xa;Solid: Service call&#xa;Dashed: Internal step&#xa;Red Loop: Reasoning iteration" style="rounded=0;fillColor=#FFF;strokeColor=#333;strokeWidth=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="750" y="560" width="200" height="90" as="geometry" />
        </mxCell>

        <mxCell id="key_point" value="KEY: All loops happen&#xa;WITHIN 1 request&#xa;BEFORE sending response" style="rounded=0;fillColor=#FFE6E6;strokeColor=#E74C3C;strokeWidth=2;align=center;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="750" y="680" width="200" height="70" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
