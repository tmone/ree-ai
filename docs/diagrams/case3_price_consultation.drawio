<mxfile host="app.diagrams.net">
  <diagram name="Case 3: Price Consultation" id="case3">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="900">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="Case 3: Price Consultation (PRICE_CONSULTATION) - NOT IMPLEMENTED" style="text;fontSize=18;fontStyle=1;align=center;fontColor=#E74C3C;" vertex="1" parent="1">
          <mxGeometry x="300" y="40" width="800" height="30" as="geometry" />
        </mxCell>

        <!-- Entry -->
        <mxCell id="user" value="USER" style="shape=actor;fillColor=#90EE90;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="80" y="140" width="40" height="60" as="geometry" />
        </mxCell>

        <mxCell id="webui" value="Open WebUI" style="rounded=1;fillColor=#90EE90;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="180" y="150" width="120" height="40" as="geometry" />
        </mxCell>

        <!-- Orchestrator -->
        <mxCell id="orch" value="Orchestrator" style="rounded=1;fillColor=#FFD700;strokeColor=#333333;strokeWidth=3;fontStyle=1;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="380" y="140" width="140" height="60" as="geometry" />
        </mxCell>

        <!-- Services -->
        <mxCell id="service_label" value="Layer 3 Services" style="text;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="800" y="100" width="150" height="30" as="geometry" />
        </mxCell>

        <mxCell id="classification" value="Classification Service&#xa;:8083" style="rounded=1;fillColor=#FFEB99;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="800" y="140" width="180" height="50" as="geometry" />
        </mxCell>

        <mxCell id="extraction" value="Extraction Service&#xa;:8084" style="rounded=1;fillColor=#FFEB99;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="800" y="320" width="180" height="50" as="geometry" />
        </mxCell>

        <mxCell id="price" value="Price Suggestion Service&#xa;:8087&#xa;NOT INTEGRATED" style="rounded=1;fillColor=#FFE6E6;strokeColor=#E74C3C;strokeWidth=2;dashed=1;dashPattern=5 5;" vertex="1" parent="1">
          <mxGeometry x="800" y="470" width="180" height="70" as="geometry" />
        </mxCell>

        <!-- Internal Reasoning Loop Box -->
        <mxCell id="loop_box" value="" style="rounded=1;fillColor=none;strokeColor=#E74C3C;strokeWidth=3;dashed=1;dashPattern=5 5;" vertex="1" parent="1">
          <mxGeometry x="330" y="260" width="280" height="340" as="geometry" />
        </mxCell>

        <mxCell id="loop_label" value="REASONING LOOP (Proposed)&#xa;(within single request)" style="text;fontSize=12;fontStyle=1;fontColor=#E74C3C;" vertex="1" parent="1">
          <mxGeometry x="340" y="270" width="260" height="35" as="geometry" />
        </mxCell>

        <!-- Loop Steps -->
        <mxCell id="step1" value="Step 1:&#xa;Extract Property Info" style="rounded=1;fillColor=#E8F4F8;strokeColor=#4A90E2;strokeWidth=2;dashed=1;dashPattern=3 3;" vertex="1" parent="1">
          <mxGeometry x="370" y="320" width="200" height="50" as="geometry" />
        </mxCell>

        <mxCell id="step2" value="Step 2:&#xa;Market Analysis" style="rounded=1;fillColor=#E8F4F8;strokeColor=#4A90E2;strokeWidth=2;dashed=1;dashPattern=3 3;" vertex="1" parent="1">
          <mxGeometry x="370" y="400" width="200" height="50" as="geometry" />
        </mxCell>

        <mxCell id="step3" value="Step 3:&#xa;Compare &amp; Validate" style="rounded=1;fillColor=#E8F4F8;strokeColor=#4A90E2;strokeWidth=2;dashed=1;dashPattern=3 3;" vertex="1" parent="1">
          <mxGeometry x="370" y="480" width="200" height="50" as="geometry" />
        </mxCell>

        <mxCell id="decision" value="Confidence?&#xa;&gt;= 0.8&#xa;OR max iter" style="rhombus;fillColor=#FFE6CC;strokeColor=#D79B00;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="410" y="560" width="120" height="80" as="geometry" />
        </mxCell>

        <!-- Exit loop -->
        <mxCell id="step4" value="Step 4:&#xa;Generate Consultation" style="rounded=1;fillColor=#E8F4F8;strokeColor=#4A90E2;strokeWidth=2;dashed=1;dashPattern=3 3;" vertex="1" parent="1">
          <mxGeometry x="370" y="680" width="200" height="50" as="geometry" />
        </mxCell>

        <mxCell id="response" value="Response:&#xa;Price range + insights" style="rounded=1;fillColor=#90EE90;strokeColor=#333333;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="390" y="770" width="160" height="50" as="geometry" />
        </mxCell>

        <!-- TODO Box -->
        <mxCell id="todo" value="TODO Implementation:&#xa;1. Add PRICE_CONSULTATION intent&#xa;2. Create handler with reasoning loop&#xa;3. Integrate Price Service&#xa;4. Add market data analysis&#xa;5. Implement confidence scoring" style="rounded=0;fillColor=#FFF9C4;strokeColor=#F57C00;strokeWidth=2;align=left;" vertex="1" parent="1">
          <mxGeometry x="60" y="320" width="240" height="140" as="geometry" />
        </mxCell>

        <!-- Connections -->
        <mxCell id="e1" value="" edge="1" parent="1" source="user" target="webui">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e2" value="" edge="1" parent="1" source="webui" target="orch">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e3" value="1. Classify" edge="1" parent="1" source="orch" target="classification" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e4" value="2. Extract&#xa;(loop N times)" edge="1" parent="1" source="step1" target="extraction" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e5" value="3. Analyze&#xa;(TODO)" edge="1" parent="1" source="step2" target="price" style="strokeWidth=2;dashed=1;dashPattern=5 5;strokeColor=#E74C3C;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e6" value="Start loop" edge="1" parent="1" source="orch" target="step1" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e7" value="property_info" edge="1" parent="1" source="step1" target="step2" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e8" value="market_data" edge="1" parent="1" source="step2" target="step3" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e9" value="validation" edge="1" parent="1" source="step3" target="decision" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e10" value="NO: Refine" edge="1" parent="1" source="decision" target="step2" style="dashed=1;dashPattern=5 5;strokeWidth=3;strokeColor=#E74C3C;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="260" y="600" />
              <mxPoint x="260" y="425" />
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="e11" value="YES: Exit loop" edge="1" parent="1" source="decision" target="step4" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e12" value="" edge="1" parent="1" source="step4" target="response" style="dashed=1;dashPattern=3 3;strokeWidth=2;">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="e13" value="" edge="1" parent="1" source="response" target="webui" style="strokeWidth=2;edgeStyle=orthogonalEdgeStyle;">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="240" y="795" />
              <mxPoint x="240" y="170" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Example -->
        <mxCell id="example" value="Example Single Request:&#xa;User: Can ho 2PN Q2 gia bao nhieu?&#xa;&#xa;Iter 1: Analyze 50 properties&#xa;Confidence: 0.6 - Too low&#xa;&#xa;Iter 2: Add location filters&#xa;Confidence: 0.85 - OK&#xa;&#xa;Response:&#xa;Gia trung binh: 5.2 ty&#xa;Khoang: 4.5 - 6.8 ty&#xa;Tang 8% trong 6 thang" style="rounded=0;fillColor=#E1F5E1;strokeColor=#4CAF50;strokeWidth=2;align=left;" vertex="1" parent="1">
          <mxGeometry x="60" y="490" width="240" height="230" as="geometry" />
        </mxCell>

        <!-- Reasoning Details -->
        <mxCell id="reasoning" value="Reasoning Loop Logic:&#xa;1. Extract: District, bedrooms&#xa;2. Market: Query similar props&#xa;3. Validate: Check data quality&#xa;4. Refine if needed:&#xa;   - Adjust filters&#xa;   - Expand search area&#xa;   - Check more sources" style="rounded=0;fillColor=#E3F2FD;strokeColor=#2196F3;strokeWidth=2;align=left;" vertex="1" parent="1">
          <mxGeometry x="800" y="630" width="220" height="170" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend" value="Legend:&#xa;Solid: Service call&#xa;Dashed: Internal step&#xa;Red Loop: Reasoning&#xa;Red Dashed: Not ready" style="rounded=0;fillColor=#FFF;strokeColor=#333;strokeWidth=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="1070" y="140" width="180" height="110" as="geometry" />
        </mxCell>

        <mxCell id="key_point" value="KEY: Reasoning loop&#xa;analyzes market data&#xa;multiple times for&#xa;best answer" style="rounded=0;fillColor=#FFE6E6;strokeColor=#E74C3C;strokeWidth=2;align=center;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1070" y="280" width="180" height="90" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
